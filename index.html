<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

  <!-- FontAwesome & Tailwind -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Custom CSS for trophy shaking animation */
    @keyframes shakeTrophy {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(10deg); }
      50% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
      100% { transform: rotate(0deg); }
    }
    @keyframes shakeLost {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
    .trophy-shake {
      display: inline-block;
      animation: shakeTrophy 0.5s ease-in-out;
    }
    .lost-shake {
      display: inline-block;
      animation: shakeLost 0.5s ease-in-out;
    }

    .alert-banner {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { background-color: #fee2e2; }
      50% { background-color: #fecaca; }
      100% { background-color: #fee2e2; }
    }
  </style>
</head>
<body class="bg-Lite green-100 font-['El_Messiri']">
  
  <div class="container mx-auto p-5">
    <h1 class="text-center text-3xl font-bold text-green-600">TKS AI PRO</h1>

    <!-- Alert Banner (hidden by default) -->
    <div id="alert-banner" class="alert-banner hidden p-3 rounded-lg shadow-md mb-4 text-center border border-red-500">
      <p class="text-red-700 font-bold"><i class="fas fa-exclamation-triangle mr-2"></i> WARNING: 3 CONSECUTIVE LOSSES DETECTED!</p>
      <p class="text-red-600">System recommends stopping play for 10 rounds</p>
    </div>

    <!-- Period & Result Box -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4 text-center">
      <p class="text-lg font-semibold text-gray-700"><i class="fas fa-calendar-alt"></i> Period: <span id="period-number" class="text-black"></span></p>
      <p class="text-lg font-semibold text-lite blu-700"><i class="fas fa-chart-line"></i> Result: <span id="predicted-result" class="text-green-500 font-bold">Loading...</span></p>
      <div class="mt-2">
        <div class="accuracy-meter">
          <div id="accuracy-fill" class="accuracy-fill" style="width: 0%"></div>
        </div>
        <p class="text-sm text-gray-600 mt-1">AI Accuracy: <span id="accuracy-value">0%</span></p>
      </div>
    </div>

    <!-- Analysis Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4">
      <h2 class="text-lg font-semibold text-gray-700 text-center">Analysis</h2>
      <div class="grid grid-cols-3 gap-4 mt-2">
        <div class="bg-green-50 p-3 rounded text-center">
          <p class="text-gray-600">Win Count</p>
          <p id="won-count" class="text-xl font-bold text-green-500">0</p>
        </div>
        <div class="bg-green-50 p-3 rounded text-center">
          <p class="text-gray-600">Loss Count</p>
          <p id="lost-count" class="text-xl font-bold text-red-500">0</p>
        </div>
        <div class="bg-green-50 p-3 rounded text-center">
          <p class="text-gray-600">Win %</p>
          <p id="won-percentage" class="text-xl font-bold text-green-500">0%</p>
        </div>
      </div>
    </div>

    <!-- Auto Reserve Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4">
      <h2 class="text-lg font-semibold text-gray-700 text-center">Auto Reserve</h2>
      <div class="flex justify-between items-center mt-2">
        <span class="text-sm text-gray-600">Status:</span>
        <span id="auto-reserve-status" class="text-sm font-bold text-green-500">Active</span>
      </div>
      <div class="mt-2">
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Next Prediction:</span>
          <span id="next-prediction" class="text-sm font-bold text-blue-500">Calculating...</span>
        </div>
      </div>
    </div>

    <!-- Pattern Detection Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4">
      <h2 class="text-lg font-semibold text-gray-700 text-center">Pattern Detection</h2>
      <div id="pattern-info" class="text-center text-sm text-gray-600 mt-2">
        Analyzing game patterns...
      </div>
    </div>

    <!-- History Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4">
      <h2 class="text-lg font-semibold text-gray-700 text-center">History</h2>
      <div id="history-list" class="grid grid-cols-1 gap-1 mt-1"></div>
    </div>
  </div>

  <script>
  let previousResults = [];
  let latestResult = null;
  let latestPeriod = null;
  let storedHistory = JSON.parse(localStorage.getItem("gameHistory")) || [];
  let model;
  let currentStreak = 0;
  let streakType = ''; // 'win' or 'loss'
  let totalPredictions = 0;
  let correctPredictions = 0;
  let autoReserveActive = true;
  let reservePattern = null;
  let consecutiveLosses = 0;
  let roundsToSkip = 0;

  // ✅ Initialize AI Model
  async function initializeModel() {
    model = tf.sequential();
    model.add(tf.layers.dense({units: 32, inputShape: [10], activation: 'relu'}));
    model.add(tf.layers.dropout({rate: 0.2}));
    model.add(tf.layers.dense({units: 16, activation: 'relu'}));
    model.add(tf.layers.dropout({rate: 0.2}));
    model.add(tf.layers.dense({units: 1, activation: 'sigmoid'}));
    model.compile({optimizer: 'adam', loss: 'binaryCrossentropy', metrics: ['accuracy']});
  }

  // ✅ Prepare data for AI prediction
  function prepareData(results) {
    // Convert results to numerical values (1 for SMALL, 0 for BIG)
    const numericalData = results.map(result => result.number <= 4 ? 1 : 0);
    // Pad with zeros if we don't have enough history
    while (numericalData.length < 10) {
      numericalData.unshift(0);
    }
    return tf.tensor2d([numericalData.slice(0, 10)]);
  }

  // ✅ AI Prediction Strategy with improved pattern detection
  async function predictWithAI(results) {
    if (roundsToSkip > 0) {
      roundsToSkip--;
      document.getElementById('alert-banner').classList.remove('hidden');
      document.getElementById('auto-reserve-status').textContent = "Paused (" + roundsToSkip + " rounds left)";
      document.getElementById('auto-reserve-status').className = "text-sm font-bold text-yellow-500";
      return "SKIPPING (" + roundsToSkip + " left)";
    } else {
      document.getElementById('alert-banner').classList.add('hidden');
    }
    
    if (results.length < 5) {
      // Fallback to simple strategy if not enough data
      return results[0]?.number <= 4 ? 'SMALL' : 'BIG';
    }
    
    // Check for patterns
    const lastFive = results.slice(0, 5).map(r => r.number);
    const lastTen = results.slice(0, 10).map(r => r.number);
    
    // Pattern 1: Alternating small/big
    let isAlternating = true;
    for (let i = 1; i < lastFive.length; i++) {
      const prevSmall = lastFive[i-1] <= 4;
      const currSmall = lastFive[i] <= 4;
      if (prevSmall === currSmall) {
        isAlternating = false;
        break;
      }
    }
    if (isAlternating) {
      reservePattern = "Alternating";
      document.getElementById('pattern-info').textContent = "Pattern detected:SURYA AI Alternating results";
      return lastFive[0] <= 4 ? 'BIG' : 'SMALL';
    }
    
    // Pattern 2: Streak of same type
    const allSmall = lastFive.every(n => n <= 4);
    const allBig = lastFive.every(n => n > 4);
    if (allSmall) {
      reservePattern = "Small Streak";
      document.getElementById('pattern-info').textContent = "Pattern detected: AI 5+ SMALL results in a row";
      return 'BIG';
    }
    if (allBig) {
      reservePattern = "Big Streak";
      document.getElementById('pattern-info').textContent = "Pattern detected:SURYA AI5+ BIG results in a row";
      return 'SMALL';
    }
    
    // Pattern 3: 3-1-1 pattern (e.g., SMALL-SMALL-SMALL-BIG-SMALL)
    if (lastFive.length >= 5) {
      const pattern = lastFive.slice(0, 5).map(n => n <= 4 ? 'S' : 'B').join('');
      if (pattern === 'SSSBS' || pattern === 'BBBAB') {
        reservePattern = "3-1-1 Sequence";
        document.getElementById('pattern-info').textContent = "Pattern detected: DATA BASE3-1-1 sequence";
        return pattern[4] === 'S' ? 'BIG' : 'SMALL';
      }
    }
    
    // Use neural network as fallback
    reservePattern = "AI Neural Network";
    document.getElementById('pattern-info').textContent = "Using AI Calculation  prediction";
    const inputData = prepareData(results);
    const prediction = await model.predict(inputData).data();
    const confidence = Math.abs(prediction[0] - 0.5) * 2; // Convert to 0-1 range
    return prediction[0] > 0.5 ? 'SMALL' : 'BIG';
  }

  // ✅ Fetch Current Game Issue
  async function fetchCurrentGameIssue() {
    const apiUrl = 'https://api.bdg88zf.com/api/webapi/GetGameIssue';
    const requestData = {
      typeId: 1,
      language: 0,
      random: "40079dcba93a48769c6ee9d4d4fae23f",
      signature: "D12108C4F57C549D82B23A91E0FA20AE",
      timestamp: 1727792520,
    };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;charset=UTF-8' },
        body: JSON.stringify(requestData),
      });

      if (response.ok) {
        const data = await response.json();
        if (data.code === 0) {
          latestPeriod = data.data.issueNumber;
          document.getElementById('period-number').textContent = latestPeriod;
          fetchPreviousResults();
        }
      }
    } catch (error) {
      console.error("❌ Fetch error:", error);
    }
  }

  // ✅ Fetch Previous Results
  async function fetchPreviousResults() {
    const apiUrl = 'https://api.bdg88zf.com/api/webapi/GetNoaverageEmerdList';
    const requestData = {
      pageSize: 10,
      pageNo: 1,
      typeId: 1,
      language: 0,
      random: "c2505d9138da4e3780b2c2b34f2fb789",
      signature: "7D637E060DA35C0C6E28DC6D23D71BED",
      timestamp: 1727792520,
    };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;charset=UTF-8' },
        body: JSON.stringify(requestData),
      });

      if (response.ok) {
        const data = await response.json();
        if (data.code === 0 && data.data.list.length > 0) {
          previousResults = data.data.list;
          updateResults();
        }
      }
    } catch (error) {
      console.error("❌ Fetch error:", error);
    }
  }

  // ✅ Update Results with AI Prediction
  async function updateResults() {
    if (previousResults.length > 0) {
      latestResult = await predictWithAI(previousResults);
      document.getElementById('predicted-result').textContent = latestResult;
      document.getElementById('next-prediction').textContent = `${latestResult} (${reservePattern})`;
      updateHistory();
    }
  }

  // ✅ Update History with trophy shaking effect for WON and lost shaking effect for LOST
  function updateHistory() {
    const historyContainer = document.getElementById('history-list');
    historyContainer.innerHTML = '';

    const newHistoryEntry = {
      period: latestPeriod.toString().slice(-4),
      prediction: latestResult,
      status: "PENDING",
      actualResult: null
    };

    if (!storedHistory.some(entry => entry.period === newHistoryEntry.period)) {
      storedHistory.unshift(newHistoryEntry);
    }

    // Check if we need to update the status of the previous prediction
    const prevPeriod = storedHistory[1];
    let shouldAnimateWin = false;
    let shouldAnimateLost = false;
    
    if (prevPeriod && prevPeriod.status === "PENDING") {
      // Get the actual result from the previous period
      const actualNumber = previousResults[0]?.number;
      const actualResult = actualNumber <= 4 ? 'SMALL' : 'BIG';
      
      prevPeriod.actualResult = actualResult;
      prevPeriod.status = prevPeriod.prediction === actualResult ? "WON" : "LOST";
      
      // Update accuracy metrics
      if (prevPeriod.status === "WON") {
        correctPredictions++;
        consecutiveLosses = 0; // Reset consecutive losses counter
      } else {
        consecutiveLosses++; // Increment consecutive losses counter
      }
      totalPredictions++;
      
      // Check for 3 consecutive losses
      if (consecutiveLosses >= 3) {
        roundsToSkip = 10;
        document.getElementById('alert-banner').classList.remove('hidden');
        // You could also play a sound or show a more prominent alert here
      }
      
      // Update streak counter
      if (prevPeriod.status === "WON") {
        if (streakType === 'win') {
          currentStreak++;
        } else {
          currentStreak = 1;
          streakType = 'win';
        }
        shouldAnimateWin = true;
      } else {
        if (streakType === 'loss') {
          currentStreak++;
        } else {
          currentStreak = 1;
          streakType = 'loss';
        }
        shouldAnimateLost = true;
      }
    }

    // Update accuracy display
    const accuracy = totalPredictions > 0 ? (correctPredictions / totalPredictions) * 100 : 0;
    document.getElementById('accuracy-value').textContent = accuracy.toFixed(2) + '%';
    document.getElementById('accuracy-fill').style.width = accuracy + '%';
    
    // Update auto reserve status
    if (roundsToSkip === 0) {
      document.getElementById('auto-reserve-status').textContent = autoReserveActive ? "Active" : "Inactive";
      document.getElementById('auto-reserve-status').className = autoReserveActive ? 
        "text-sm font-bold text-green-500" : "text-sm font-bold text-red-500";
    }

    let winCount = 0, lossCount = 0;
    storedHistory.slice(0, 10).forEach((entry, index) => {
      const box = document.createElement('div');
      box.className = `history-box text-center p-3 rounded-lg mb-2 ${
        entry.status === 'WON' ? 'bg-green-100 border-l-4 border-green-500' : 
        entry.status === 'LOST' ? 'bg-red-100 border-l-4 border-red-500' : 
        'bg-yellow-100 border-l-4 border-yellow-500'
      }`;

      // Add trophy icon with shake effect for WON entries and cross icon with shake for LOST
      const statusIcon = entry.status === 'WON' ? 
        `<span class="trophy-shake"><i class="fas fa-trophy"></i></span>` :
        entry.status === 'LOST' ? '<span class="lost-shake"><i class="fas fa-times-circle"></i></span>' : 
        '<i class="fas fa-clock"></i>';

      // Alternative display for actual result
      const resultDisplay = entry.actualResult ? 
        `<div class="text-xs mt-1">
          <span class="font-semibold">Actual:</span> 
          <span class="${entry.actualResult === 'SMALL' ? 'text-blue-900' : 'text-purple-600'}">
            ${entry.actualResult}
          </span>
        </div>` : '';

      box.innerHTML = `
        <div class="flex flex-col">
          <div class="flex justify-between items-center">
            <p class="text-gray-600">Period: <span class="font-bold text-black">${entry.period}</span></p>
            <p class="text-gray-600">Prediction: <span class="font-bold ${
              entry.prediction === 'SMALL' ? 'text-blue-600' : 'text-purple-600'
            }">${entry.prediction}</span></p>
          </div>
          <div class="flex justify-between items-center mt-1">
            <p class="${entry.status === 'WON' ? 'text-green-600 font-bold' : 
              entry.status === 'LOST' ? 'text-red-600 font-bold' : 
              'text-yellow-600 font-bold'}">
              ${statusIcon} ${entry.status}
            </p>
            ${resultDisplay}
          </div>
        </div>
      `;

      historyContainer.appendChild(box);

      if (entry.status === "WON") winCount++;
      else if (entry.status === "LOST") lossCount++;
    });

    localStorage.setItem("gameHistory", JSON.stringify(storedHistory.slice(0, 10)));

    document.getElementById('won-count').textContent = winCount;
    document.getElementById('lost-count').textContent = lossCount;
    document.getElementById('won-percentage').textContent = 
      (winCount + lossCount > 0) ? ((winCount / (winCount + lossCount)) * 100).toFixed(2) + "%" : "0%";

    // Trigger animation effects
    if (shouldAnimateWin) {
      const trophyElements = document.querySelectorAll('.trophy-shake');
      if (trophyElements.length > 0) {
        trophyElements[0].classList.add('animate-shake');
        setTimeout(() => {
          trophyElements[0].classList.remove('animate-shake');
        }, 1000);
      }
    }
    if (shouldAnimateLost) {
      const lostElements = document.querySelectorAll('.lost-shake');
      if (lostElements.length > 0) {
        lostElements[0].classList.add('animate-shake');
        setTimeout(() => {
          lostElements[0].classList.remove('animate-shake');
        }, 1000);
      }
    }
  }

  // Initialize and start the process
  (async function init() {
    await initializeModel();
    // Load accuracy data from localStorage if available
    const savedAccuracy = JSON.parse(localStorage.getItem("accuracyData")) || {total: 0, correct: 0};
    totalPredictions = savedAccuracy.total;
    correctPredictions = savedAccuracy.correct;
    
    // Load consecutive losses count
    consecutiveLosses = parseInt(localStorage.getItem("consecutiveLosses")) || 0;
    
    // ✅ Auto-Fetch Every 5 Seconds
    setInterval(fetchCurrentGameIssue, 5000);
    fetchCurrentGameIssue();
    
    // Save accuracy data before unload
    window.addEventListener('beforeunload', () => {
      localStorage.setItem("accuracyData", JSON.stringify({
        total: totalPredictions,
        correct: correctPredictions
      }));
      localStorage.setItem("consecutiveLosses", consecutiveLosses.toString());
    });
  })();
  </script>
</body>
</html>
