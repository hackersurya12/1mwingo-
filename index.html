<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

  <!-- FontAwesome & Tailwind -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Custom CSS for trophy shaking animation */
    @keyframes shakeTrophy {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(10deg); }
      50% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
      100% { transform: rotate(0deg); }
    }
    .trophy-shake {
      display: inline-block;
      animation: shakeTrophy 0.5s ease-in-out;
    }
    .accuracy-meter {
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);
    }
    .accuracy-fill {
      height: 100%;
      border-radius: 5px;
      background-color: #10b981;
      transition: width 0.5s ease;
    }
  </style>
</head>
<body class="bg-Lite green-100 font-['El_Messiri']">
  
  <div class="container mx-auto p-5">
    <h1 class="text-center text-3xl font-bold text-green-600">TKS AI PRO</h1>

    <!-- Period & Result Box -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4 text-center">
      <p class="text-lg font-semibold text-gray-700"><i class="fas fa-calendar-alt"></i> Period: <span id="period-number" class="text-black"></span></p>
      <p class="text-lg font-semibold text-lite blu-700"><i class="fas fa-chart-line"></i> Result: <span id="predicted-result" class="text-green-500 font-bold">Loading...</span></p>
      <div class="mt-2">
        <div class="accuracy-meter">
          <div id="accuracy-fill" class="accuracy-fill" style="width: 0%"></div>
        </div>
        <p class="text-sm text-gray-600 mt-1">AI Accuracy: <span id="accuracy-value">0%</span></p>
      </div>
    </div>

    <!-- Analysis Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4">
      <h2 class="text-lg font-semibold text-gray-700 text-center">Analysis</h2>
      <div class="grid grid-cols-2 gap-4 mt-2">
        <div class="bg-green-50 p-3 rounded text-center">
          <p class="text-gray-600">Win Count</p>
          <p id="won-count" class="text-xl font-bold text-green-500">0</p>
        </div>
        <div class="bg-green-50 p-3 rounded text-center">
          <p class="text-gray-600">Loss Count</p>
          <p id="lost-count" class="text-xl font-bold text-red-500">0</p>
        </div>
        <div class="bg-green-50 p-3 rounded text-center">
          <p class="text-gray-600">Win %</p>
          <p id="won-percentage" class="text-xl font-bold text-green-500">0%</p>
        </div>
        <div class="bg-green-50 p-3 rounded text-center">
          <p class="text-gray-600">Streak</p>
          <p id="current-streak" class="text-xl font-bold text-gray-500">0</p>
        </div>
      </div>
    </div>

    <!-- Pattern Detection Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4">
      <h2 class="text-lg font-semibold text-gray-700 text-center">Period Analysis</h2>
      <div id="pattern-info" class="text-center text-sm text-gray-600 mt-2">
        Analyzing period patterns...
      </div>
    </div>

    <!-- History Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4">
      <h2 class="text-lg font-semibold text-gray-700 text-center">History</h2>
      <div id="history-list" class="grid grid-cols-1 gap-1 mt-1"></div>
    </div>
  </div>

  <script>
  let previousResults = [];
  let latestResult = null;
  let latestPeriod = null;
  let storedHistory = JSON.parse(localStorage.getItem("gameHistory")) || [];
  let currentStreak = 0;
  let streakType = ''; // 'win' or 'loss'
  let totalPredictions = 0;
  let correctPredictions = 0;

  // ✅ New Period-Based Prediction Strategy
  function predictBasedOnPeriod(periodNumber) {
    // Convert period number to a string and get the last 4 digits
    const periodStr = periodNumber.toString();
    const lastFour = periodStr.slice(-4);
    
    // Calculate the sum of the last 4 digits
    const digitSum = lastFour.split('').reduce((sum, digit) => sum + parseInt(digit), 0);
    
    // Apply our prediction algorithm
    if (digitSum % 3 === 0) {
      // If sum is divisible by 3, predict SMALL
      document.getElementById('pattern-info').textContent = "Period analysis: Digit sum divisible by 3";
      return 'SMALL';
    } else if (digitSum % 5 === 0) {
      // If sum is divisible by 5, predict BIG
      document.getElementById('pattern-info').textContent = "Period analysis: Digit sum divisible by 5";
      return 'BIG';
    } else if (digitSum % 2 === 0) {
      // If sum is even, look at the last digit
      const lastDigit = parseInt(lastFour.slice(-1));
      if (lastDigit <= 4) {
        document.getElementById('pattern-info').textContent = "Period analysis: Even sum with last digit ≤4";
        return 'SMALL';
      } else {
        document.getElementById('pattern-info').textContent = "Period analysis: Even sum with last digit >4";
        return 'BIG';
      }
    } else {
      // If sum is odd, use a different strategy
      const middleTwo = parseInt(lastFour.slice(1, 3));
      if (middleTwo < 50) {
        document.getElementById('pattern-info').textContent = "Period analysis: Odd sum with middle digits <50";
        return 'SMALL';
      } else {
        document.getElementById('pattern-info').textContent = "Period analysis: Odd sum with middle digits ≥50";
        return 'BIG';
      }
    }
  }

  // ✅ Fetch Current Game Issue
  async function fetchCurrentGameIssue() {
    const apiUrl = 'https://api.bdg88zf.com/api/webapi/GetGameIssue';
    const requestData = {
      typeId: 1,
      language: 0,
      random: "40079dcba93a48769c6ee9d4d4fae23f",
      signature: "D12108C4F57C549D82B23A91E0FA20AE",
      timestamp: 1727792520,
    };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;charset=UTF-8' },
        body: JSON.stringify(requestData),
      });

      if (response.ok) {
        const data = await response.json();
        if (data.code === 0) {
          latestPeriod = data.data.issueNumber;
          document.getElementById('period-number').textContent = latestPeriod;
          fetchPreviousResults();
        }
      }
    } catch (error) {
      console.error("❌ Fetch error:", error);
    }
  }

  // ✅ Fetch Previous Results
  async function fetchPreviousResults() {
    const apiUrl = 'https://api.bdg88zf.com/api/webapi/GetNoaverageEmerdList';
    const requestData = {
      pageSize: 10,
      pageNo: 1,
      typeId: 1,
      language: 0,
      random: "c2505d9138da4e3780b2c2b34f2fb789",
      signature: "7D637E060DA35C0C6E28DC6D23D71BED",
      timestamp: 1727792520,
    };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;charset=UTF-8' },
        body: JSON.stringify(requestData),
      });

      if (response.ok) {
        const data = await response.json();
        if (data.code === 0 && data.data.list.length > 0) {
          previousResults = data.data.list;
          updateResults();
        }
      }
    } catch (error) {
      console.error("❌ Fetch error:", error);
    }
  }

  // ✅ Update Results with Period-Based Prediction
  async function updateResults() {
    if (latestPeriod) {
      latestResult = predictBasedOnPeriod(latestPeriod);
      document.getElementById('predicted-result').textContent = latestResult;
      updateHistory();
    }
  }

  // ✅ Update History with trophy shaking effect for WON
  function updateHistory() {
    const historyContainer = document.getElementById('history-list');
    historyContainer.innerHTML = '';

    const newHistoryEntry = {
      period: latestPeriod.toString().slice(-4),
      prediction: latestResult,
      status: "PENDING",
      actualResult: null
    };

    if (!storedHistory.some(entry => entry.period === newHistoryEntry.period)) {
      storedHistory.unshift(newHistoryEntry);
    }

    // Check if we need to update the status of the previous prediction
    const prevPeriod = storedHistory[1];
    let shouldAnimate = false;
    
    if (prevPeriod && prevPeriod.status === "PENDING") {
      // Get the actual result from the previous period
      const actualNumber = previousResults[0]?.number;
      const actualResult = actualNumber <= 4 ? 'SMALL' : 'BIG';
      
      prevPeriod.actualResult = actualResult;
      prevPeriod.status = prevPeriod.prediction === actualResult ? "WON" : "LOST";
      
      // Update accuracy metrics
      if (prevPeriod.status === "WON") {
        correctPredictions++;
      }
      totalPredictions++;
      
      // Update streak counter
      if (prevPeriod.status === "WON") {
        if (streakType === 'win') {
          currentStreak++;
        } else {
          currentStreak = 1;
          streakType = 'win';
        }
      } else {
        if (streakType === 'loss') {
          currentStreak++;
        } else {
          currentStreak = 1;
          streakType = 'loss';
        }
      }
      
      shouldAnimate = prevPeriod.status === "WON";
    }

    // Update accuracy display
    const accuracy = totalPredictions > 0 ? (correctPredictions / totalPredictions) * 100 : 0;
    document.getElementById('accuracy-value').textContent = accuracy.toFixed(2) + '%';
    document.getElementById('accuracy-fill').style.width = accuracy + '%';
    
    // Update streak display
    document.getElementById('current-streak').textContent = currentStreak + (streakType === 'win' ? 'W' : 'L');
    document.getElementById('current-streak').className = streakType === 'win' ? 
      'text-xl font-bold text-green-500' : 'text-xl font-bold text-red-500';

    let winCount = 0, lossCount = 0;
    storedHistory.slice(0, 10).forEach((entry, index) => {
      const box = document.createElement('div');
      box.className = `history-box text-center p-3 rounded-lg mb-2 ${
        entry.status === 'WON' ? 'bg-green-100 border-l-4 border-green-500' : 
        entry.status === 'LOST' ? 'bg-red-100 border-l-4 border-red-500' : 
        'bg-yellow-100 border-l-4 border-yellow-500'
      }`;

      // Add trophy icon with shake effect for WON entries
      const statusIcon = entry.status === 'WON' ? 
        `<span class="trophy-shake"><i class="fas fa-trophy"></i></span>` :
        entry.status === 'LOST' ? '<i class="fas fa-times-circle"></i>' : 
        '<i class="fas fa-clock"></i>';

      // Alternative display for actual result
      const resultDisplay = entry.actualResult ? 
        `<div class="text-xs mt-1">
          <span class="font-semibold">Actual:</span> 
          <span class="${entry.actualResult === 'SMALL' ? 'text-blue-900' : 'text-purple-600'}">
            ${entry.actualResult}
          </span>
        </div>` : '';

      box.innerHTML = `
        <div class="flex flex-col">
          <div class="flex justify-between items-center">
            <p class="text-gray-600">Period: <span class="font-bold text-black">${entry.period}</span></p>
            <p class="text-gray-600">Prediction: <span class="font-bold ${
              entry.prediction === 'SMALL' ? 'text-blue-600' : 'text-purple-600'
            }">${entry.prediction}</span></p>
          </div>
          <div class="flex justify-between items-center mt-1">
            <p class="${entry.status === 'WON' ? 'text-green-600 font-bold' : 
              entry.status === 'LOST' ? 'text-red-600 font-bold' : 
              'text-yellow-600 font-bold'}">
              ${statusIcon} ${entry.status}
            </p>
            ${resultDisplay}
          </div>
        </div>
      `;

      historyContainer.appendChild(box);

      if (entry.status === "WON") winCount++;
      else if (entry.status === "LOST") lossCount++;
    });

    localStorage.setItem("gameHistory", JSON.stringify(storedHistory.slice(0, 10)));

    document.getElementById('won-count').textContent = winCount;
    document.getElementById('lost-count').textContent = lossCount;
    document.getElementById('won-percentage').textContent = 
      (winCount + lossCount > 0) ? ((winCount / (winCount + lossCount)) * 100).toFixed(2) + "%" : "0%";

    // Trigger trophy animation for wins
    if (shouldAnimate) {
      const trophyElements = document.querySelectorAll('.trophy-shake');
      if (trophyElements.length > 0) {
        trophyElements[0].classList.add('animate-shake');
        setTimeout(() => {
          trophyElements[0].classList.remove('animate-shake');
        }, 1000);
      }
    }
  }

  // Initialize and start the process
  (function init() {
    // Load accuracy data from localStorage if available
    const savedAccuracy = JSON.parse(localStorage.getItem("accuracyData")) || {total: 0, correct: 0};
    totalPredictions = savedAccuracy.total;
    correctPredictions = savedAccuracy.correct;
    
    // ✅ Auto-Fetch Every 5 Seconds
    setInterval(fetchCurrentGameIssue, 5000);
    fetchCurrentGameIssue();
    
    // Save accuracy data before unload
    window.addEventListener('beforeunload', () => {
      localStorage.setItem("accuracyData", JSON.stringify({
        total: totalPredictions,
        correct: correctPredictions
      }));
    });
  })();
  </script>
</body>
</html>
